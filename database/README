# 环境准备
conda activate infound_back_local  # 或使用已有 venv

(Infound_back) [root@iZj6cb91ptjm4ha7v89erbZ Code]# pwd
/root/Infound/Code
(Infound_back) [root@iZj6cb91ptjm4ha7v89erbZ Code]# ls
tiktok_partner_back  tiktok_partner_back_local  video_analysis

# 默认数据库位置
- 默认落在 `tiktok_partner_back/data/infound_dev.db`（自动创建目录）
- 如果需要改动，设置 `DB_URL` 环境变量即可，支持任意 SQLAlchemy 连接串
- 线上服务器路径对应 `/root/Infound/Code/tiktok_partner_back/data/infound_dev.db`
- 数据库内 `created_at`/`updated_at` 均以北京时间 (+08:00) 记录

# 初始化步骤（在 tiktok_partner_back 目录）
cp database/.env.example database/.env    # 如需覆盖 DB_URL / ECHO_SQL
# 如果已经存在 database/.env，请确认其中 DB_URL=sqlite:///./data/infound_dev.db
python -m database.create_tables          # 初始化所有数据表

# 验证写入（可选）
python - <<'PY'
from database.ingest_task_info import log_task_info_to_db
log_task_info_to_db({"task_id": "demo-1", "task_name": "Demo"})
print("OK task")
PY

python - <<'PY'
from database.ingest_creator_data import log_creator_snapshot_to_db
log_creator_snapshot_to_db({"creator_id":"cr-1","creator_name":"Alice","region":"US"}, task_id="demo-1", shop_name="DemoShop")
print("OK creator")
PY

# 达人 Excel 导入
python -m database.ingest_creator_excel --file data/creator_GOKOCO.MX.xlsx --task-id=creator_excel --shop-name=GOKOCO
# 不传参数默认使用文件名作为 task_id，brand_name 或 ExcelImport 作为 shop_name

# 商品库
- Excel 放在 `tiktok_partner_back/data/product_data/product_list.xlsx`（旧路径 `data/product/` 仍可兼容，但建议迁移）
- 建议包含字段（**至少需要 `product_link`**）：
  `backend_system_id`,`region`,`campaign_id`,`campaign_name`,`product_name`,`thumbnail`,`product_id`,`sale_price`,`SKU_product`,`shop_name`,`campaign_start_time`,`campaign_end_time`,`creator_rate`,`partner_rate`,`affiliate_link`,`product_link`,`cost_product`,`available_samples`,`stock`,`item_sold`,`product_name_cn`,`selling_point`,`selling_point_cn`,`shooting_guide`,`shooting_guide_cn`,`product_category_name`
- 同一 `product_id` 多次导入会直接覆盖旧记录（更新全部字段和 `updated_at`）
- 上传接口支持额外传入 `region` 字段，用于填充 Excel 中缺失的地区（仅覆盖空值）

# 导入商品库（手动触发一次即可）
python - <<'PY'
from database.ingest_product_excel import ingest_default_product_excel
result = ingest_default_product_excel(uploaded_by="backend")
print(result)
PY

# 查看数据库内容（SQLite 默认）
# 方法一：sqlite3 命令行
sqlite3 data/infound_dev.db <<'SQL'
.tables
SELECT COUNT(*) AS creators FROM creator;
SELECT creator_id, creator_name, region, updated_at FROM creator LIMIT 5;
SELECT COUNT(*) AS creator_logs FROM creator_log;
SELECT COUNT(*) AS products FROM product;
SQL

# 方法二：Python 快速查询
python - <<'PY'
from database.db import get_session
from database.models import Creator, Product
with get_session() as db:
    print("Creators:", db.query(Creator).count())
    print("Products:", db.query(Product).count())
    for c in db.query(Creator).limit(5):
        print(c.creator_id, c.creator_name, c.region)
PY

# 高级查看工具
# 直接在仓库根目录运行：
python -m database.view_database --tables
python -m database.view_database --count creator product
python -m database.view_database --head creator:3 creator_log:2
python -m database.view_database --summary

# 查看指定表的前几行
python -m database.view_database --head outreach_task:5
python -m database.view_database --head product:10
python -m database.view_database --head creator_log:3

# 自定义 SQL
python -m database.view_database --sql "SELECT creator_id, creator_name FROM creator LIMIT 3"
python -m database.view_database --sql "SELECT * FROM outreach_task ORDER BY created_at DESC LIMIT 5"
python -m database.view_database --sql "SELECT creator_id, creator_name, updated_at FROM creator ORDER BY updated_at DESC LIMIT 5"

# sqlite3 方式
sqlite3 data/infound_dev.db '.tables'
sqlite3 data/infound_dev.db 'SELECT COUNT(*) FROM creator;'
sqlite3 data/infound_dev.db 'SELECT * FROM product ORDER BY created_at DESC LIMIT 5;'
sqlite3 data/infound_dev.db 'SELECT task_id, task_name, created_at FROM outreach_task ORDER BY created_at DESC LIMIT 3;'

# API 给前端使用
- `GET  /api/v1/product/list`            查询商品列表（返回所有字段，含 `thumbnail` 图片地址）。支持 `region`、`campaign_id`、`shop_name`、`product_category_name`、`keyword`、`offset/limit` 等参数。
  ```bash
  curl -H "Authorization: Bearer $TOKEN" \
    "http://127.0.0.1:8000/api/v1/product/list?region=MX&shop_name=CleanHome&product_category_name=Household%20Appliances&keyword=steam&offset=0&limit=50"
  ```
- `GET  /api/v1/product/items/{id}`      查看单条商品记录（按数据库 ID）
  ```bash
  curl -H "Authorization: Bearer $TOKEN"     "http://127.0.0.1:8000/api/v1/product/items/42"
  ```
- `GET  /api/v1/product/items/by-product-id/{product_id}` 根据业务 `product_id` 查询商品
  ```bash
  curl -H "Authorization: Bearer $TOKEN"     "http://127.0.0.1:8000/api/v1/product/items/by-product-id/1732458007988897731"
  ```
- `PUT  /api/v1/product/items/{id}`      修改商品信息（未提供 `cost_product` 时会基于最新 `sale_price` 自动计算 30% 并保留货币符号）
  ```bash
  curl -X PUT http://127.0.0.1:8000/api/v1/product/items/42     -H "Authorization: Bearer $TOKEN"     -H "Content-Type: application/json"     -d '{"sale_price":"$199.00","partner_rate":"15%"}'
  ```
- `DELETE /api/v1/product/items/{id}`    按数据库 ID 删除商品
  ```bash
  curl -X DELETE http://127.0.0.1:8000/api/v1/product/items/42     -H "Authorization: Bearer $TOKEN"
  ```
- `DELETE /api/v1/product/items/by-product-id/{product_id}` 按业务 `product_id` 删除商品（会删除全部匹配记录）
  ```bash
  curl -X DELETE http://127.0.0.1:8000/api/v1/product/items/by-product-id/1732458007988897731     -H "Authorization: Bearer $TOKEN"
  ```
- `POST /api/v1/product/sync-from-excel` 将最新 `product_list.xlsx` 导入数据库（支持 `use_dify` 与 `region` 查询参数）
  ```bash
  curl -X POST \"http://127.0.0.1:8000/api/v1/product/sync-from-excel?use_dify=false&region=MX\" \\
    -H \"Authorization: Bearer $TOKEN\"
  ```
- `POST /api/v1/product/upload-excel`    上传 Excel 文件并落库（支持 `note`、`use_dify`）
- `POST /api/v1/product/batch`           通过 JSON 批量写入商品库
- 商品卡任务 API：
  - `POST /api/v1/card/tasks` 同时上传达人 Excel (`creator_name`,`creator_id`) 与商品 Excel (`campaign_id`,`product_id`,`rate`,`message`)，自动生成 `card_send_list_xxx.json` 并可选择是否立即发送（`generate_only=true` 时只生成 JSON）。
  - `GET /api/v1/card/tasks` / `GET /api/v1/card/tasks/{task_id}` 用于查看任务进度，产物保存在 `data/card/tasks/<task_id>/`，同时同步覆盖 `data/card/card_send_list.json` 为最新配置。
  - Playwright 参数可通过表单字段控制：`headless`、`verify_delivery`、`manual_login_timeout`。开启发送后会沿用 `product_card/chat_card.py` 的逻辑处理商品卡。

# 数据表说明
- `creator`：达人主档，每个 `creator_id` 一行，包含昵称、粉丝数、地区、联系方式以及视频/直播平均指标，用于前端快速列表和去重。
- `creator_log`：达人抓取快照，记录每次任务采集到的业务数据、粉丝分布、外联状态等，字段与 Excel 快照一致。
- `outreach_task`：建联任务头信息，存储任务配置（品牌、筛选条件：包含 gmv/sales 区间、min/max_GMV、邮件模板；旧字段 `min_sales` 仅用于兼容历史数据）与运行统计（新达人数量、任务目录等）。
  - 新增字段 `task_type`（默认 `Connect`），用于标记 Connect / Card 两类任务，前端可基于此区分来源。
- `outreach_task_log`：任务事件日志表，目前仅保留骨架，后续用于记录状态变更/告警。
- `product`：商品库信息，与 `upload_batch` 关联，包含 region/campaign/SKU/shop 等字段，供前端展示。
